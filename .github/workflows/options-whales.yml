name: Options Whale Trades Collection

on:
  schedule:
    # Noon ET (mid-market) - EST: 17:00 UTC, EDT: 16:00 UTC
    - cron: '0 17 * * 1-5'  # EST (Nov-Mar)
    # - cron: '0 16 * * 1-5'  # EDT (Mar-Nov) - uncomment when observing daylight saving time
    
    # 9 PM ET (post-market) - EST: 02:00 UTC next day, EDT: 01:00 UTC next day
    - cron: '0 2 * * 2-6'   # EST (Nov-Mar) - runs Tue-Sat for Mon-Fri market close
    # - cron: '0 1 * * 2-6'   # EDT (Mar-Nov) - uncomment when observing daylight saving time
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (5 sample tickers only)'
        required: false
        default: false
        type: boolean
      lookback_days:
        description: 'Number of trading days to look back'
        required: false
        default: '5'
        type: string

env:
  DATA_REPO: "${{ github.repository_owner }}/deanfi-data"
  DATA_REPO_TOKEN: "${{ secrets.DATA_REPO_TOKEN }}"
  ALPACA_API_KEY: "${{ secrets.ALPACA_API_KEY }}"
  ALPACA_API_SECRET: "${{ secrets.ALPACA_API_SECRET }}"

jobs:
  fetch-options-whales:
    runs-on: ubuntu-latest
    
    # Queue all data collectors to prevent git conflicts when writing to deanfi-data repo
    concurrency:
      group: deanfi-data-repo
      cancel-in-progress: false
    
    steps:
      - name: Checkout collectors repo
        uses: actions/checkout@v4
      
      - name: Checkout data repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DATA_REPO }}
          token: ${{ secrets.DATA_REPO_TOKEN }}
          path: data-cache
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Fetch options whale trades
        run: |
          cd optionswhales
          
          # Build command with optional flags
          CMD="python fetch_options_whales.py"
          
          if [ "${{ inputs.test_mode }}" = "true" ]; then
            CMD="$CMD --test"
            echo "ðŸ§ª Running in TEST mode (5 sample tickers)"
          fi
          
          if [ -n "${{ inputs.lookback_days }}" ] && [ "${{ inputs.lookback_days }}" != "5" ]; then
            CMD="$CMD --lookback ${{ inputs.lookback_days }}"
            echo "ðŸ“… Using custom lookback: ${{ inputs.lookback_days }} trading days"
          fi
          
          echo "ðŸ‹ Starting options whale collection..."
          $CMD
          echo "âœ… Options whale collection complete"
      
      - name: Copy output to data repo
        run: |
          mkdir -p data-cache/options-whales
          cp optionswhales/*.json data-cache/options-whales/ 2>/dev/null || echo "No JSON files found in optionswhales/"
          echo "ðŸ“¦ Output files:"
          ls -la data-cache/options-whales/
      
      - name: Commit and push to data repo
        run: |
          cd data-cache
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add options-whales/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Determine run type for commit message
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              RUN_TYPE="manual"
            else
              HOUR=$(date -u +%H)
              if [ "$HOUR" -ge "15" ] && [ "$HOUR" -le "18" ]; then
                RUN_TYPE="mid-market"
              else
                RUN_TYPE="post-market"
              fi
            fi
            
            git commit -m "ðŸ‹ Options whale trades update ($RUN_TYPE) - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git pull --rebase origin main
            git push
            echo "âœ… Changes pushed to data repo"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ‹ Options Whale Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "data-cache/options-whales/options_whale_summary.json" ]; then
            echo "- **Generated**: $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
            # Extract stats using jq-style parsing
            TICKERS=$(python3 -c "import json; d=json.load(open('data-cache/options-whales/options_whale_summary.json')); print(d.get('metadata',{}).get('tickers_scanned','N/A'))")
            WHALES=$(python3 -c "import json; d=json.load(open('data-cache/options-whales/options_whale_summary.json')); print(d.get('metadata',{}).get('tickers_with_whales','N/A'))")
            TRADES=$(python3 -c "import json; d=json.load(open('data-cache/options-whales/options_whale_summary.json')); print(d.get('metadata',{}).get('total_whale_trades','N/A'))")
            SWEEPS=$(python3 -c "import json; d=json.load(open('data-cache/options-whales/options_whale_summary.json')); print(d.get('metadata',{}).get('sweeps_detected','N/A'))")
            SENTIMENT=$(python3 -c "import json; d=json.load(open('data-cache/options-whales/options_whale_summary.json')); print(d.get('overall_sentiment',{}).get('direction','N/A'))")
            RATIO=$(python3 -c "import json; d=json.load(open('data-cache/options-whales/options_whale_summary.json')); print(d.get('overall_sentiment',{}).get('call_put_ratio','N/A'))")
            echo "- **Tickers Scanned**: $TICKERS" >> $GITHUB_STEP_SUMMARY
            echo "- **Tickers with Whales**: $WHALES" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Whale Trades**: $TRADES" >> $GITHUB_STEP_SUMMARY
            echo "- **Sweeps Detected**: $SWEEPS" >> $GITHUB_STEP_SUMMARY
            echo "- **Overall Sentiment**: $SENTIMENT" >> $GITHUB_STEP_SUMMARY
            echo "- **Call/Put Ratio**: $RATIO" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Summary file not found" >> $GITHUB_STEP_SUMMARY
          fi
